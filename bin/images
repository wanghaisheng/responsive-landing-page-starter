#!/usr/bin/env node
const fs = require('fs')
const path = require('path')
const fm = require('front-matter')
const globby = require('globby')
const download = require('image-downloader')
const yaml = require('yaml')

const dir = 'content/blog'
const outputDir = `static/${dir}`

const walk = async () => {
  return await globby(path.join(dir, '**/*.md'))
}

const images = async () => {
  const files = await walk()

  files.slice(0, 10).forEach((file) => {
    const raw = fs.readFileSync(file, 'utf8')
    const { attributes, ...data } = fm(raw)
    const { thumbnail: url } = attributes
    const slug = path.basename(file, path.extname(file))

    if (url.startsWith('https://')) {
      const dest = `${outputDir}/${slug}`

      if (!fs.existsSync(dest)) {
        fs.mkdirSync(dest)
      }

      download
        .image({
          url,
          dest,
        })
        .then(({ filename }) => {
          console.log('Saved image: ', filename)

          attributes.thumbnail = `/${filename.replace(outputDir, dir)}`

          const markdown = `---\n${yaml.stringify(attributes)}---\n\n${
            data.body
          }`

          fs.writeFile(file, markdown, (error) => {
            if (!error) {
              console.log(`Updated post: \`${file}\` ...`)
            } else {
              console.error(error)
            }
          })
        })
        .catch((err) => console.error(err))
    }
  })
}

images()
